---
title: "Cloud Storageã«ã‚¢ãƒƒãƒ—ã—ãŸtarãƒ•ã‚¡ã‚¤ãƒ«ã‚’Cloud Functionã§è§£å‡ã™ã‚‹"
emoji: "ğŸ§Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['googlecloud', 'nodejs', 'linux', 'firebase', 'cloudfunctions', 'cloudstorage', 'tar']
published: true
---

# ã¯ã˜ã‚ã«
- Cloud Storageã«ã‚¢ãƒƒãƒ—ã—ãŸtarãƒ•ã‚¡ã‚¤ãƒ«ã‚’Cloud Functionã§è§£å‡ã™ã‚‹æ–¹æ³•ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚
- è¦šæ›¸ç¨‹åº¦ã«æ®‹ã—ã¦ã‚ã‚Šã¾ã™ã®ã§ã€æ±šã„ã®ã¯ã”äº†æ‰¿ãã ã•ã„ğŸ˜“ï¼ˆè¦æœ›ãŒã‚ã‚Œã°ç¶ºéº—ã«ã—ã‚ˆã†ã‹ã¨ï¼‰

# ç’°å¢ƒ
- Cloud Functionsï¼ˆç¬¬äºŒä¸–ä»£ï¼‰
- Cloud Storage
- Node.js

# è§£å‡ã™ã‚‹ã‚³ãƒ¼ãƒ‰

```package.json
# package.json
{
    "@google-cloud/functions-framework": "^3.0.0",
    "firebase-admin": "^12.0.0",
    "tar": "^7.0.0"
  }
}
```

```javascript
// index.js
const functions = require("@google-cloud/functions-framework");
const admin = require("firebase-admin");
const tar = require("tar");
const path = require("path");
const os = require("os");
const fs = require("fs");

admin.initializeApp();

functions.http("decompressCsv", async (req, res) => {
  try {
    /**
     * ãƒã‚±ãƒƒãƒˆåã‚’æŒ‡å®šã—ã¦ã€å‚ç…§ã‚’å–å¾—ã—ã€tar.gz ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
     * fileNameã«ã¯ã€ãƒã‚±ãƒƒãƒˆä»¥ä¸‹ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹ï¼ˆä¾‹ï¼š hoge/fuga.tar.gzï¼‰
     */
    const bucket = admin.storage().bucket(req.query.bucketName);
    const file = bucket.file(req.query.fileName);

    // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’å–å¾—ã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const tempFilePath = path.join(os.tmpdir(), path.basename(file.name));
    await file.download({ destination: tempFilePath });

    /**
     * tar.gz ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£å‡
     * å¿µã®ç‚ºã€è§£å‡å…ˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åˆ¥ã§ä½œæˆã—ã¦ãŠã
     */
    const extractPath = path.join(os.tmpdir(), "extracted");
    await fs.promises.mkdir(extractPath, { recursive: true }); // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãªã‘ã‚Œã°ä½œæˆ
    await tar.x({ file: tempFilePath, cwd: extractPath });

    /**
     * è§£å‡ã•ã‚ŒãŸ .csv ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã—ã€å–å¾—
     */
    const files = await fs.promises.readdir(extractPath);
    const csvFiles = files.filter((file) => file.endsWith(".csv"));
    if (csvFiles.length === 0) {
      throw new Error("No .csv files found in the extracted directory");
    }
    const csvFileName = csvFiles[0];
    const csvFilePath = path.join(extractPath, csvFileName);

    /**
     * è§£å‡ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Cloud Storage ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
     */
    const extractedFiles = await bucket.upload(csvFilePath, {
      // ã“ã“ã¯ã€ãƒã‚±ãƒƒãƒˆä»¥ä¸‹ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹ï¼ˆä¾‹ï¼š hoge/fuga.csvï¼‰
      destination: "extracted/" + csvFileName,
    });

    console.log(
      `Extracted files: ${extractedFiles.map((file) => file.name).join(", ")}`
    );

    /**
     * å…ƒã® tar.gz ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
     */
    await bucket.file(file.name).delete();

    res.send(`DONE!`);
  } catch (e) {
    console.error("Error", e);

    res.status(500).send(`Error: ${e.message}`);
  }
});
```
