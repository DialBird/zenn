---
title: "Terraformã§ã€Cloud Pub/Sub -> Cloud Functions -> BigQuery Jobã®æµã‚Œã‚’ä½œã‚‹"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['gcp', 'terraform', 'cloudpubsub']
published: true
---

# ã¯ã˜ã‚ã«

- ãƒ¡ãƒ¢æ›¸ãç¨‹åº¦ã«æ®‹ã—ã¦ã‚ã‚Šã¾ã™ã€‚
- æ±šã„ã®ã¯ã”äº†æ‰¿ãã ã•ã„ğŸ˜“

# ç’°å¢ƒ

- Terraform
- Cloud Pub/Sub
- Cloud Functions
- BigQuery
- Node.js

# å‰æçŸ¥è­˜
## Cloud Pub/Sub ã‚¹ã‚­ãƒ¼ãƒã«ã¤ã„ã¦
https://cloud.google.com/pubsub/docs/schemas?hl=ja

- Pub/Sub ã®ãƒˆãƒ”ãƒƒã‚¯ã«æµã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚­ãƒ¼ãƒã¯ã€Avro ã‹ ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒãƒƒãƒ•ã‚¡ã¨ã„ã†ã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚‰ã—ã„
- ä»Šå›ã¯ã€è¦‹ãŸç›®ãŒJSONã§æ‰±ã„ã‚„ã™ãã†ãªAvroã‚’ä½¿ã£ã¦ã¿ã‚‹

## Cloud FunctionçµŒç”±ã§ BigQuery ã®ã‚¯ã‚¨ãƒªã‚’ã€å‹•çš„ã«å®Ÿè¡Œã™ã‚‹æ–¹æ³•
- æœ€åˆã¯ Cloud Functions ã‹ã‚‰ BigQuery Job ã‚’å‘¼ã³å‡ºã™æ–¹æ³•ã‚’æ¢ã—ã¦ã„ãŸãŒã€çµå±€è¦‹ã¤ã‹ã‚‰ãš
- çµè«–ã€Cloud Function å†…ã§ BigQuery ã®ã‚¯ã‚¨ãƒªã‚’å®šç¾©ãƒ»å®Ÿè¡Œã™ã‚‹ã“ã¨ã«

## BigQueryã®ã‚¯ã‚¨ãƒªã«å¤‰æ•°ã‚’æ¸¡ã™æ–¹æ³•
- NAMEDï¼ˆ@ã‚’ã¤ã‘ã‚‹ï¼‰ ã¨ã„ã†ã®ã¨ã€PARAMETERS ã¨ã„ã†ã®ãŒã‚ã‚‹
- ä»Šå›ã¯ã€NAMED ã‚’ä½¿ã£ã¦ã¿ã‚‹
```sh
# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
.
â”œâ”€â”€ main.tf
â””â”€â”€ schemas
   â””â”€â”€ schema.avsc
```

```tf
# main.tf
resource "google_pubsub_schema" "sample_pubsub_schema" {
  name       = "sample-pubsub-schema"
  type       = "AVRO"
  definition = file("schemas/schema.avsc")
}

resource "google_pubsub_topic" "sample" {
  name       = "sample"
  depends_on = [google_pubsub_schema.sample_pubsub_schema]
  schema_settings {
    schema   = google_pubsub_schema.sample_pubsub_schema.id
    encoding = "JSON"
  }
}

```

```json
# schemas/schema.avscï¼ˆAvroã®æ‹¡å¼µå­ã¯avscï¼‰

{
  "type": "record",
  "name": "Avro",
  "fields": [
    {
      "name": "userId",
      "type": "string"
    },
    {
      "name": "message",
      "type": "string"
    }
  ]
}

```

- ã“ã“ã¾ã§è¡Œã‘ã‚Œã°ã€ã‚ã¨ã¯Terraformã§åæ˜ ã™ã‚Œã°ã€ã‚¹ã‚­ãƒ¼ãƒ

```sh
$ terraform apply

# ã‚¹ã‚­ãƒ¼ãƒã«åˆã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Œã‚‹
$ gcloud pubsub topics publish voter-point-aggregation --message='{"userId": "1", "message": "hello" }'
# messageIds:
# - 'XXX'

# ã‚‚ã—ã‚¹ã‚­ãƒ¼ãƒã«åˆã‚ãªã„ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ãŸã‚‰ã€ã“ã‚“ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹
$ gcloud pubsub topics publish voter-point-aggregation --message='hello'
#ERROR: (gcloud.pubsub.topics.publish) INVALID_ARGUMENT: Invalid data in message: Message failed schema validation.
```

# Cloud Pub/Sub ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦ã€Cloud Functions ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆ
- ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹æ–¹æ³•ã¯ä»¥ä¸‹ã®é€šã‚Š

```ts
const functions = require('@google-cloud/functions-framework')

functions.cloudEvent('sample', async (event) => {
  // ãƒ‡ãƒ¼ã‚¿ã¯ base64 ã§é£›ã‚“ã§ãã‚‹ã®ã§ã€ä¸€æ—¦æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹
  const decodedString = Buffer.from(event.data.message.data, 'base64').toString('utf-8')
  // æ–‡å­—åˆ—ã‚’JSONã«å¤‰æ›ã™ã‚‹
  const jsonData = JSON.parse(decodedString)

  // ã‚ã¨ã¯ JSON ã¨ã—ã¦æ‰±ãˆã‚‹
  console.log('data', jsonData)
})
```
