---
title: "Cloud Workflowã‹ã‚‰ã€Cloud Storageå†…éƒ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦èª­ã¿è¾¼ã‚€"
emoji: "ğŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['googlecloud', 'cloudworkflow', 'cloudstorage']
published: true
---

# æ¦‚è¦
- Cloud Workflow å†…ã«ã€Œé•·ã„SQLã€ã‚’æ›¸ãå¿…è¦ãŒã‚ã‚‹å ´åˆã€å½“ç„¶ã ãŒã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆãŒåŠ¹ã‹ãªã„ãªã©ã§å¯èª­æ€§ãŒä¸‹ãŒã‚‹
- ãã“ã§SQLãƒ•ã‚¡ã‚¤ãƒ«è‡ªä½“ã‚’ã€Cloud Storage å†…ã«ç½®ã„ã¦ãŠãã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Cloud Workflow å†…ã§èª­ã¿è¾¼ã‚ã‚Œã°å¯èª­æ€§ãŒä¸ŠãŒã‚‹ã¨è€ƒãˆãŸ
- ã—ã‹ã—å°‘ã—ã‚³ãƒ„ãŒå¿…è¦ã ã£ãŸã®ã§ã€ãƒ¡ãƒ¢ã—ã¦ãŠã

# çµè«–
- Google APIsã®[storage.v1.objects.get](https://cloud.google.com/workflows/docs/reference/googleapis/storage/v1/objects/get) ã® `alt: 'media'` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’ã€Œãƒã‚¤ãƒŠãƒªã¨ã—ã¦ã€å–å¾—ã§ãã‚‹
- å–å¾—ã—ãŸãƒã‚¤ãƒŠãƒªã‚’ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›ã—ã¦ä½¿ã†

# ã‚³ãƒ¼ãƒ‰
- ä»¥ä¸‹ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰ã—ã¦
```yaml
main:
  params: [event]
  steps:
    - init:
        assign:
          - projectId: ${event.projectId}
          - bucket: ${event.bucket}
    - log_event:
        call: sys.log
        args:
          data: ${event}
    - read_sql_from_gcs:
        call: googleapis.storage.v1.objects.get
        args:
          bucket: ${bucket}
          object: 'sample.sql' # èª­ã¿è¾¼ã‚€ãƒ•ã‚¡ã‚¤ãƒ«å
          alt: 'media' # ã“ã‚Œã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’ã€Œãƒã‚¤ãƒŠãƒªã¨ã—ã¦ã€å–å¾—ã§ãã‚‹
        result: aggregate_query # å–å¾—ã—ãŸãƒã‚¤ãƒŠãƒªã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°

    # ã‚ã¨ã¯ä»»æ„ã®ã‚¹ãƒ†ãƒƒãƒ—ã§æ–‡å­—åˆ—ã¨ã—ã¦ä½¿ã†
    - aggregate_votes:
        call: googleapis.bigquery.v2.jobs.insert
        args:
          projectId: ${projectId}
          body:
            configuration:
              query:
                query: ${text.decode(aggregate_query)} # ä½¿ã†æ™‚ã«ãƒã‚¤ãƒŠãƒªã‚’ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›ã™ã‚‹

```
