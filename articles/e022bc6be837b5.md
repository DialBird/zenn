---
title: "Prismaã¨PGLiteã€Vitestã§ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹"
emoji: "ğŸ’­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['Prisma', 'PGLite', 'Vitest']
published: false
---

## ã¯ã˜ã‚ã«

ãƒ¢ãƒ€ãƒ³ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«ãŠã„ã¦ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å«ã‚€ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã¯å¸¸ã«èª²é¡Œã¨ãªã‚Šã¾ã™ã€‚å¾“æ¥ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå•é¡ŒãŒã‚ã‚Šã¾ã—ãŸï¼š

- **Docker Compose** ã«ã‚ˆã‚‹å®Ÿéš›ã®PostgreSQLã®èµ·å‹•ï¼šé‡ãã€CIã§ã®å®Ÿè¡Œæ™‚é–“ãŒé•·ã„
- **SQLite** ã®ä½¿ç”¨ï¼šæœ¬ç•ªç’°å¢ƒï¼ˆPostgreSQLï¼‰ã¨ã®å·®ç•°ã«ã‚ˆã‚‹å•é¡Œç™ºç”Ÿ
- **ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªDB** ã®åˆ©ç”¨ï¼šæ©Ÿèƒ½åˆ¶é™ã‚„SQLæ–¹è¨€ã®é•ã„

æœ¬è¨˜äº‹ã§ã¯ã€ã“ã‚Œã‚‰ã®èª²é¡Œã‚’è§£æ±ºã™ã‚‹ **PGLite** ã‚’ä½¿ã£ãŸè»½é‡ã‹ã¤é«˜é€Ÿãªãƒ†ã‚¹ãƒˆç’°å¢ƒã®æ§‹ç¯‰æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## PGLiteã¨ã¯

[PGLite](https://github.com/electric-sql/pglite) ã¯ã€WebAssemblyä¸Šã§å‹•ä½œã™ã‚‹PostgreSQLã§ã™ã€‚ä¸»ãªç‰¹å¾´ã¯ï¼š

- **è»½é‡**: WebAssemblyã«ã‚ˆã‚‹é«˜é€Ÿèµ·å‹•
- **å®Œå…¨äº’æ›**: å®Ÿéš›ã®PostgreSQLã¨åŒã˜SQLæ©Ÿèƒ½
- **ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒª**: æ°¸ç¶šåŒ–ãªã—ã®é«˜é€Ÿå®Ÿè¡Œ
- **ä¾å­˜é–¢ä¿‚ãªã—**: Dockerã‚„PostgreSQLã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

ä»Šå›æ§‹ç¯‰ã™ã‚‹ãƒ†ã‚¹ãƒˆç’°å¢ƒã®æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ï¼š

- **PGLite**: WebAssemblyç‰ˆPostgreSQL
- **Prisma**: ORMã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†
- **Vitest**: é«˜é€Ÿãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼
- **pglite-prisma-adapter**: PGLiteã¨Prismaã®æ¥ç¶šã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼

## åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```json
{
  "dependencies": {
    "@electric-sql/pglite": "^0.3.3",
    "@prisma/client": "6.9.0",
    "pglite-prisma-adapter": "^0.5.0"
  },
  "devDependencies": {
    "vitest": "^2.1.8",
    "prisma": "6.9.0"
  }
}
```

### 2. Vitestã®è¨­å®š

```typescript
// vitest.config.mts
import { defineConfig } from 'vitest/config'

export default defineConfig({
  test: {
    environment: 'jsdom',
    globalSetup: './vitest-global-setup.ts',
  },
})
```

## PGliteTestDbManagerã®å®Ÿè£…

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã«ã¯ä»¥ä¸‹ã®è¦ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

1. **ã‚¹ã‚­ãƒ¼ãƒåˆæœŸåŒ–ã®æœ€é©åŒ–**: å…¨ãƒ†ã‚¹ãƒˆã§1å›ã®ã¿å®Ÿè¡Œ
2. **ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å…±æœ‰**: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æœ€é©åŒ–
3. **ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: ãƒ†ã‚¹ãƒˆé–“ã®ç‹¬ç«‹æ€§ä¿è¨¼
4. **ç«¶åˆçŠ¶æ…‹ã®å›é¿**: ä¸¦è¡Œãƒ†ã‚¹ãƒˆå®Ÿè¡Œã§ã®å®‰å…¨æ€§

### åŸºæœ¬å®Ÿè£…

```typescript
export class PGliteTestDbManager extends PrismaClientManager {
  private initialized = false
  
  // å…±æœ‰PGliteã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆå…¨ã¦ã®ãƒ†ã‚¹ãƒˆã§ä½¿ã„å›ã—ï¼‰
  private static sharedPGlite: PGlite | null = null
  private static schemaInitialized = false
  
  // åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹ã®Promiseï¼ˆç«¶åˆçŠ¶æ…‹ã‚’é˜²ããŸã‚ï¼‰
  private static initializationPromise: Promise<PGlite> | null = null
}
```

### ã‚¹ã‚­ãƒ¼ãƒåˆæœŸåŒ–ã®æœ€é©åŒ–

æœ€ã‚‚é‡è¦ãªæœ€é©åŒ–ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®åˆæœŸåŒ–ã‚’å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã«1å›ã®ã¿è¡Œã†ã“ã¨ã§ã™ï¼š

```typescript
/**
 * Prismaã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰åˆæœŸåŒ–SQLã‚’ç”Ÿæˆ
 */
private static generateInitSQL(): string {
  try {
    const schemaPath = join(__dirname, '../../prisma/schema.prisma')
    const command = `pnpx prisma migrate diff --from-empty --to-schema-datamodel ${schemaPath} --script`
    
    const sql = execSync(command, {
      encoding: 'utf-8',
      cwd: join(__dirname, '../..'),
    })
    
    return sql
  } catch (error) {
    console.error('Failed to generate init SQL:', error)
    throw error
  }
}
```

### ç«¶åˆçŠ¶æ…‹ã®å›é¿

ä¸¦è¡Œãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã®ç«¶åˆçŠ¶æ…‹ã‚’é˜²ããŸã‚ã€åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã‚’åˆ¶å¾¡ã—ã¾ã™ï¼š

```typescript
/**
 * å…±æœ‰PGliteã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ï¼ˆã‚¹ã‚­ãƒ¼ãƒåˆæœŸåŒ–ã¯æœ€åˆã®ä¸€å›ã®ã¿ï¼‰
 * ç«¶åˆçŠ¶æ…‹ã‚’é˜²ããŸã‚ã€åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã‚’ä¸€åº¦ã ã‘å®Ÿè¡Œã™ã‚‹
 */
private static async getSharedPGlite(): Promise<PGlite> {
  // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã®å ´åˆã¯å³åº§ã«è¿”ã™
  if (PGliteTestDbManager.sharedPGlite && PGliteTestDbManager.schemaInitialized) {
    return PGliteTestDbManager.sharedPGlite
  }
  
  // åˆæœŸåŒ–ä¸­ã®å ´åˆã¯æ—¢å­˜ã®Promiseã‚’è¿”ã™ï¼ˆç«¶åˆçŠ¶æ…‹ã‚’é˜²ãï¼‰
  if (PGliteTestDbManager.initializationPromise) {
    return PGliteTestDbManager.initializationPromise
  }
  
  // åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹
  PGliteTestDbManager.initializationPromise = PGliteTestDbManager.performInitialization()
  
  try {
    const result = await PGliteTestDbManager.initializationPromise
    return result
  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯åˆæœŸåŒ–Promiseã‚’ã‚¯ãƒªã‚¢
    PGliteTestDbManager.initializationPromise = null
    throw error
  }
}
```

## Vitestã¨ã®çµ±åˆ

### ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«å…±æœ‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ï¼š

```typescript
// vitest-global-setup.ts
import { PGliteTestDbManager } from './infrastructure/dev/test-db-prisma-client-manager'

export async function setup() {
  console.log('ğŸš€ Global test setup: Initializing shared PGlite database...')
  
  try {
    // å…±æœ‰PGliteã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆæœŸåŒ–ï¼ˆã‚¹ã‚­ãƒ¼ãƒä½œæˆï¼‰
    const manager = new PGliteTestDbManager()
    await manager.initializeAsync()
    
    console.log('âœ… Global test setup completed')
  } catch (error) {
    console.error('âŒ Global test setup failed:', error)
    throw error
  }
}

export async function teardown() {
  console.log('ğŸ§¹ Global test teardown: Cleaning up shared resources...')
  
  try {
    // å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹ã‚’å®Œå…¨ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    await PGliteTestDbManager.closeGlobalTestDB()
    
    console.log('âœ… Global test teardown completed')
  } catch (error) {
    console.error('âŒ Global test teardown failed:', error)
    console.warn('Continuing despite teardown error...')
  }
}
```

## ãƒ†ã‚¹ãƒˆã§ã®ä½¿ç”¨æ–¹æ³•

### ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ–¹å¼ï¼ˆæ¨å¥¨ï¼‰

```typescript
describe('ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ', () => {
  const manager = new PGliteTestDbManager()
  
  beforeEach(async () => {
    // âœ… initializeAsync()ã¯å³åº§ã«è¿”ã‚‹ï¼ˆã‚¹ã‚­ãƒ¼ãƒæ—¢ã«ä½œæˆæ¸ˆã¿ï¼‰
    await manager.initializeAsync()
    // âœ… ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆã®ã¿å®Ÿè¡Œï¼ˆé«˜é€Ÿï¼‰
    await manager.cleanupDB()
  })
  
  afterAll(async () => {
    // âœ… Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆ‡æ–­ã®ã¿
    await manager.cleanup()
  })
  
  it('ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹', async () => {
    const prisma = await manager.getClientAsync()
    
    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
    await prisma.user.create({
      data: { name: 'Test User', email: 'test@example.com' }
    })
    
    const users = await prisma.user.findMany()
    expect(users).toHaveLength(1)
  })
})
```

### é™çš„ãƒ¡ã‚½ãƒƒãƒ‰æ–¹å¼ï¼ˆå¾“æ¥äº’æ›ï¼‰

```typescript
describe('å¾“æ¥æ–¹å¼ã®ãƒ†ã‚¹ãƒˆ', () => {
  beforeEach(async () => {
    await PGliteTestDbManager.cleanupTestDB()
  })
  
  it('é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã§ã®ä½¿ç”¨ä¾‹', async () => {
    const prisma = await PGliteTestDbManager.createTestPrismaClient()
    
    await prisma.user.create({
      data: { name: 'Static Test User', email: 'static@example.com' }
    })
    
    const users = await prisma.user.findMany()
    expect(users).toHaveLength(1)
  })
})
```

## ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æˆ¦ç•¥

### åŸºæœ¬ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```typescript
/**
 * DBã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‰Šé™¤ï¼‰
 */
async cleanupDB(): Promise<void> {
  const db = await this.getPGliteInstance()
  
  // å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸€è¦§ã‚’å–å¾—
  const tables = await db.query(`
    SELECT tablename 
    FROM pg_tables 
    WHERE schemaname = 'public'
  `)
  
  // å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
  await db.exec('SET session_replication_role = replica;')
  
  // å„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’TRUNCATE
  for (const table of tables.rows) {
    await db.exec(`TRUNCATE TABLE "${(table as any).tablename}" CASCADE;`)
  }
  
  // å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’å†åº¦æœ‰åŠ¹åŒ–
  await db.exec('SET session_replication_role = DEFAULT;')
}
```

### ãƒ†ãƒ³ãƒãƒ©ãƒªãƒ†ãƒ¼ãƒ–ãƒ«å¯¾å¿œ

PostgreSQLã®ãƒ†ãƒ³ãƒãƒ©ãƒªãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ã¾ã§æ®‹å­˜ã™ã‚‹ãŸã‚ã€å¿…è¦ã«å¿œã˜ã¦æ˜ç¤ºçš„ã«å‰Šé™¤ï¼š

```typescript
/**
 * ãƒ†ãƒ³ãƒãƒ©ãƒªãƒ†ãƒ¼ãƒ–ãƒ«ã‚‚å«ã‚ãŸå®Œå…¨ãªDBã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
 */
async cleanupDBWithTempTables(): Promise<void> {
  const db = await this.getPGliteInstance()
  
  // é€šå¸¸ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  await this.cleanupDB()
  
  // ãƒ†ãƒ³ãƒãƒ©ãƒªãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸€è¦§ã‚’å–å¾—ã—ã¦å‰Šé™¤
  const tempTables = await db.query(`
    SELECT tablename 
    FROM pg_tables 
    WHERE schemaname LIKE 'pg_temp_%'
  `)
  
  for (const table of tempTables.rows) {
    await db.exec(`DROP TABLE IF EXISTS "${(table as any).tablename}" CASCADE;`)
  }
}
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. ã‚¹ã‚­ãƒ¼ãƒåˆæœŸåŒ–ã®1å›å®Ÿè¡Œ

- **å¾“æ¥**: å„ãƒ†ã‚¹ãƒˆã§ã‚¹ã‚­ãƒ¼ãƒä½œæˆï¼ˆé‡ã„ï¼‰
- **æœ€é©åŒ–å¾Œ**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§1å›ã®ã¿ï¼ˆè»½ã„ï¼‰

### 2. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å…±æœ‰

- **å¾“æ¥**: ãƒ†ã‚¹ãƒˆã”ã¨ã«æ–°ã—ã„PGliteã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
- **æœ€é©åŒ–å¾Œ**: å…±æœ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡å‰Šæ¸›

### 3. ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã®é«˜é€ŸåŒ–

- **DROP + CREATE**: ã‚¹ã‚­ãƒ¼ãƒå†ä½œæˆï¼ˆé‡ã„ï¼‰
- **TRUNCATE**: ãƒ‡ãƒ¼ã‚¿ã®ã¿å‰Šé™¤ï¼ˆè»½ã„ï¼‰

## å®Ÿè¡Œçµæœã¨ãƒ¡ãƒªãƒƒãƒˆ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š

- **ãƒ†ã‚¹ãƒˆèµ·å‹•æ™‚é–“**: Dockeræ¯”ã§ç´„80%çŸ­ç¸®
- **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“**: ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªå‹•ä½œã«ã‚ˆã‚Šé«˜é€ŸåŒ–
- **CIå®Ÿè¡Œæ™‚é–“**: ä¾å­˜é–¢ä¿‚ãªã—ã§å³åº§ã«é–‹å§‹

### é–‹ç™ºä½“é¨“ã®å‘ä¸Š

- **ç’°å¢ƒæ§‹ç¯‰ä¸è¦**: PostgreSQLã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦
- **æœ¬ç•ªç’°å¢ƒã¨ã®ä¸€è‡´**: PostgreSQLå®Œå…¨äº’æ›
- **ãƒ‡ãƒãƒƒã‚°ã®å®¹æ˜“ã•**: ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

## ã¾ã¨ã‚

PGLiteã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚¹ãƒˆç’°å¢ƒã¯ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆã‚’æä¾›ã—ã¾ã™ï¼š

1. **é«˜é€Ÿ**: WebAssemblyã«ã‚ˆã‚‹è»½é‡å®Ÿè¡Œ
2. **å®Œå…¨äº’æ›**: PostgreSQLã¨åŒã˜SQLæ©Ÿèƒ½
3. **ç°¡å˜**: è¤‡é›‘ãªç’°å¢ƒæ§‹ç¯‰ä¸è¦
4. **åŠ¹ç‡çš„**: å…±æœ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚ˆã‚‹ãƒªã‚½ãƒ¼ã‚¹æœ€é©åŒ–

å¾“æ¥ã®Docker + PostgreSQLã¨æ¯”è¼ƒã—ã¦ã€é–‹ç™ºé€Ÿåº¦ã®å‘ä¸Šã¨CIã‚³ã‚¹ãƒˆã®å‰Šæ¸›ã‚’å®Ÿç¾ã§ãã‚‹å„ªã‚ŒãŸã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚

## å‚è€ƒãƒªãƒ³ã‚¯

- [PGLite GitHub](https://github.com/electric-sql/pglite)
- [pglite-prisma-adapter](https://www.npmjs.com/package/pglite-prisma-adapter)
- [Vitest](https://vitest.dev/)
- [Prisma](https://www.prisma.io/)
